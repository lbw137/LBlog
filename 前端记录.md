# 目录
- [目录](#目录)
- [components组件自动注册](#components组件自动注册)
- [axios二次封装与token无感刷新](#axios二次封装与token无感刷新)

# components组件自动注册
```javascript
// 组件目录结构为：src/components/xxx/index.vue，命名规范为L-xxx.vue
// 在src/components/index.ts下
import { App, DefineComponent } from 'vue';
const components: Record<
  string,
  DefineComponent<{}, {}, any>
> = import.meta.glob('./**/index.vue', { eager: true });
export default {
  install(app: App) {
    // 遍历 globalComponent 对象并注册每个组件
    Object.entries(components).forEach(([name, component]) => {
      const componentName = name.split('/')[1].replace('-', '');
      app.component(componentName, component.default);
    });
  }
};
// 最后在main.ts中引入即可
import GlobalComponents from './components';
app.use(GlobalComponents);
```

# axios二次封装与token无感刷新
1. 新建一个.env.development文件，配置axios请求地址
```
NODE_ENV = 'development'
VITE_APP_BASE_API = '/api'
```
2. 反向代理解决跨域问题
```typeScript
/* vite.config.js：这里表示所有以/api开头的请求都反向代理到
http://localhost:5174，并且去掉/api这个路径
*/
server: {
    proxy: {
      '/api': {
        target: 'http://localhost:5174',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api/, '')
      }
    }
  }
```
3. 二次封装axios
```TypeScript
// src/utils/request.ts
let request = axios.create({
  // 基础路径
  baseURL: import.meta.env.VITE_APP_BASE_API,
  // 请求超时时间
  timeout: 5000
});
// 请求拦截器
request.interceptors.request.use((config) => {
  if (config.url !== '/user/login' && config.url != '/user/refreshToken') {
    // 添加短token
    config.headers.Authorization = 'Bearer ' + $store.access_token;
  }
  // 返回配置对象
  return config;
});
// 响应拦截器
request.interceptors.response.use(
  async (res) => {
    if (res.data.success) {
      // 如果是刷新token的请求，不提示消息
      if (!isRefreshRequest(res.config)) message.success(res.data.message);
      // 收集短token
      if (res.data.data.access_token) {
        $store.access_token = res.data.data.access_token;
      }
      // 收集长token
      if (res.data.data.refresh_token) {
        $store.refresh_token = res.data.data.refresh_token;
      }
    } else if (res.data.code == 401 && !isRefreshRequest(res.config)) {
      // 短token过期，用长token刷新短token
      const isSuccess = await refreshToken();
      if (isSuccess) {
        // 重新请求
        res.config.headers.Authorization = 'Bearer ' + $store.access_token;
        const resp = await request.request(res.config);
        return resp;
      } else {
        // 长token过期，跳转到登录页
        $store.access_token = '';
        $store.refresh_token = '';
      }
    } else {
      message.error(res.data.message);
    }
    // 返回简化数据
    return res.data;
  },
  (err) => {
    message.error(err.response.data.message);
    return Promise.reject(err);
  }
);
```
4. 刷新token方法
```TypeScript
let promise: Promise<boolean> | null = null;
export async function refreshToken() {
  if (promise) return promise;
  promise = new Promise(async (resolve) => {
    const res = await reqRefreshToken();
    resolve(res.success);
  });
  promise.finally(() => {
    promise = null;
  });
  return promise;
}
export function isRefreshRequest(config: InternalAxiosRequestConfig) {
  return config.headers && config.headers.__isRefreshToken;
}
```